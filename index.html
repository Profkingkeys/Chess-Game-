<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prof King Keys Chess</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<style>
:root{
  --bg:#060d1a;--bg2:#0d1b2e;--bg3:#111f35;--panel:#0f1c30;
  --border:#1e3a5f;--gold:#f5c842;--gold2:#e8a800;--blue:#3b82f6;
  --green:#22c55e;--red:#ef4444;--orange:#f97316;--purple:#a855f7;
  --teal:#14b8a6;--white:#f8fafc;--text:#cbd5e1;--muted:#64748b;
  --sq-light:#f0d9b5;--sq-dark:#b58863;--sq-size:64px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{height:100%;overflow-x:hidden;}
body{min-height:100vh;background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;overflow-x:hidden;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SPLASH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#splash{position:fixed;inset:0;z-index:1000;
  background:radial-gradient(ellipse 900px 600px at 50% 40%,rgba(59,130,246,0.15) 0%,transparent 70%),
             linear-gradient(160deg,#02080f 0%,#060d1a 50%,#020a14 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:24px;transition:opacity 0.5s;overflow-y:auto;}
#splash.hidden{opacity:0;pointer-events:none;}
.splash-logo{font-size:60px;margin-bottom:8px;text-shadow:0 0 40px rgba(245,200,66,0.6);animation:crownPulse 3s ease-in-out infinite;}
@keyframes crownPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.08);}}
.splash-title{font-size:clamp(26px,5vw,48px);font-weight:900;
  background:linear-gradient(135deg,#f5c842,#e8a800,#f5c842);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  letter-spacing:0.04em;line-height:1.1;}
.splash-subtitle{font-size:13px;color:var(--muted);letter-spacing:0.18em;text-transform:uppercase;margin-top:6px;}
.splash-tagline{font-size:15px;color:var(--text);margin:20px 0 28px;max-width:460px;line-height:1.6;}

/* â”€â”€ COLOR PICKER â”€â”€ */
.color-picker-wrap{margin-bottom:28px;}
.color-picker-label{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;font-weight:700;margin-bottom:14px;}
.color-options{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;}
.color-opt{
  display:flex;flex-direction:column;align-items:center;gap:8px;
  padding:16px 20px;border-radius:14px;cursor:pointer;
  border:2px solid var(--border);background:var(--panel);
  transition:all 0.2s;min-width:120px;
}
.color-opt:hover{transform:translateY(-4px);}
.color-opt.selected-w{border-color:#f0d9b5;box-shadow:0 0 20px rgba(240,217,181,0.3);background:rgba(240,217,181,0.08);}
.color-opt.selected-b{border-color:#555;box-shadow:0 0 20px rgba(150,150,150,0.2);background:rgba(80,80,80,0.12);}
.color-opt-piece{width:64px;height:64px;display:flex;align-items:center;justify-content:center;filter:drop-shadow(0 3px 6px rgba(0,0,0,0.7));}
.color-opt-piece svg{width:56px;height:56px;}
/* preview-white and preview-black classes kept for legacy but SVG handles styling */
.preview-white{}
.preview-black{}
.color-opt-label{font-size:13px;font-weight:700;color:var(--text);}
.color-opt-sub{font-size:10px;color:var(--muted);}

/* â”€â”€ MODE CARDS â”€â”€ */
.mode-cards{display:flex;gap:18px;flex-wrap:wrap;justify-content:center;margin-bottom:28px;}
.mode-card{width:210px;padding:24px 18px;background:var(--panel);border:1px solid var(--border);border-radius:14px;cursor:pointer;transition:transform 0.2s,border-color 0.2s,box-shadow 0.2s;text-align:center;}
@media(max-width:500px){.mode-card{width:calc(50% - 10px);min-width:140px;padding:16px 12px;}
.mode-card .mode-icon{font-size:32px;margin-bottom:6px;}
.mode-card .mode-name{font-size:14px;}
.mode-card .mode-desc{font-size:10px;}
}
.mode-card:hover{transform:translateY(-6px);border-color:var(--gold);box-shadow:0 12px 40px rgba(245,200,66,0.2);}
.mode-card .mode-icon{font-size:44px;margin-bottom:10px;}
.mode-card .mode-name{font-size:17px;font-weight:700;color:var(--white);margin-bottom:6px;}
.mode-card .mode-desc{font-size:11px;color:var(--muted);line-height:1.5;}
.mode-card.training-card:hover{border-color:var(--purple);box-shadow:0 12px 40px rgba(168,85,247,0.2);}
.splash-stages{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;max-width:400px;}
.stage-pip{width:26px;height:26px;border-radius:50%;background:var(--panel);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--muted);transition:all 0.3s;}
.stage-pip.completed{background:var(--gold);border-color:var(--gold);color:#000;}
.stage-pip.current{border-color:var(--blue);color:var(--blue);box-shadow:0 0 10px rgba(59,130,246,0.5);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:none;flex-direction:column;min-height:100vh;}
#app.show{display:flex;}
.topbar{height:52px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:14px;position:sticky;top:0;z-index:100;}
.topbar-logo{font-size:19px;font-weight:900;background:linear-gradient(135deg,#f5c842,#e8a800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;white-space:nowrap;}
.topbar-mode-badge{padding:3px 11px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;}
.topbar-mode-badge.game{background:rgba(59,130,246,0.2);color:var(--blue);border:1px solid rgba(59,130,246,0.4);}
.topbar-mode-badge.training{background:rgba(168,85,247,0.2);color:var(--purple);border:1px solid rgba(168,85,247,0.4);}
.topbar-color-badge{padding:3px 11px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid var(--border);color:var(--muted);}
.stage-indicator{margin-left:auto;display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);}
.stage-badge{padding:3px 12px;border-radius:20px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;font-weight:800;font-size:12px;}
.btn-home{margin-left:auto;background:transparent;border:1px solid var(--border);color:var(--muted);padding:5px 12px;border-radius:6px;font-size:12px;cursor:pointer;transition:color 0.15s,border-color 0.15s;}
.btn-home:hover{color:var(--white);border-color:var(--text);}

/* â”€â”€ GAME AREA â”€â”€ */
.game-area{flex:1;display:flex;padding:14px;gap:14px;justify-content:center;align-items:flex-start;flex-wrap:wrap;}
.board-col{display:flex;flex-direction:column;align-items:center;gap:8px;}
.player-bar{width:calc(var(--sq-size)*8 + 22px);padding:8px 12px;background:var(--panel);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;gap:10px;}
.player-bar.active-turn{border-color:var(--gold);box-shadow:0 0 16px rgba(245,200,66,0.15);}
.player-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.player-name{font-size:13px;font-weight:600;color:var(--white);}
.player-rating{font-size:11px;color:var(--muted);background:var(--bg3);padding:2px 7px;border-radius:4px;}
.player-captures{flex:1;text-align:right;font-size:15px;letter-spacing:-2px;min-height:20px;}
.player-clock{font-family:monospace;font-size:17px;font-weight:700;color:var(--gold);min-width:42px;text-align:right;}

/* â”€â”€ BOARD â”€â”€ */
.board-wrapper{display:flex;}
.rank-labels{display:flex;flex-direction:column;width:20px;}
.rank-labels span{height:var(--sq-size);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);font-weight:600;}
.col-wrap{display:flex;flex-direction:column;}
.file-labels{display:flex;margin-top:3px;}
.file-labels span{width:var(--sq-size);text-align:center;font-size:11px;color:var(--muted);font-weight:600;}
.board-frame{position:relative;border:3px solid #1e3a5f;border-radius:4px;box-shadow:0 0 0 1px rgba(245,200,66,0.08),0 20px 60px rgba(0,0,0,0.8);overflow:hidden;}
#board{display:grid;grid-template-columns:repeat(8,var(--sq-size));grid-template-rows:repeat(8,var(--sq-size));cursor:default;}
.sq{width:var(--sq-size);height:var(--sq-size);display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;user-select:none;}
.sq.light{background:var(--sq-light);}
.sq.dark{background:var(--sq-dark);}
.sq.selected{background:#f6f669 !important;}
.sq.last-from{background:rgba(205,210,106,0.45) !important;}
.sq.last-to{background:rgba(205,210,106,0.82) !important;}
.sq.in-check{background:radial-gradient(circle,#ff5555 0%,#cc0000 70%) !important;}
.sq.training-best{background:rgba(34,197,94,0.55) !important;box-shadow:inset 0 0 0 3px #22c55e;}
.sq.wrong-sq{background:rgba(239,68,68,0.55) !important;box-shadow:inset 0 0 0 3px #ef4444;}
.sq.legal::after{content:'';position:absolute;width:30px;height:30px;border-radius:50%;background:rgba(0,0,0,0.18);pointer-events:none;z-index:1;}
.sq.legal-cap::before{content:'';position:absolute;inset:0;box-shadow:inset 0 0 0 5px rgba(0,0,0,0.22);pointer-events:none;z-index:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PIECES â€” SVG CHESS.COM STYLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.piece{width:100%;height:100%;position:absolute;top:0;left:0;pointer-events:none;z-index:2;display:flex;align-items:center;justify-content:center;}
.piece svg{width:88%;height:88%;overflow:visible;transition:transform 0.06s;filter:drop-shadow(0 3px 5px rgba(0,0,0,0.55));}
.sq:hover .piece svg,.sq.selected .piece svg{transform:scale(1.06);}

/* Canvas arrow overlay */
#arrowCanvas{position:absolute;top:0;left:0;pointer-events:none;z-index:10;}
.sq-label{position:absolute;bottom:2px;right:3px;font-size:9px;font-weight:700;opacity:0.5;pointer-events:none;}

/* â”€â”€ GAME OVER OVERLAY â”€â”€ */
#gameOverlay{display:none;position:absolute;inset:0;background:rgba(6,13,26,0.9);flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:50;text-align:center;padding:24px;backdrop-filter:blur(4px);}
#gameOverlay.show{display:flex;}
#gameOverlay h2{font-size:clamp(22px,4vw,36px);font-weight:900;color:var(--white);}
#gameOverlay p{font-size:14px;color:var(--muted);max-width:280px;}
.overlay-btns{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;justify-content:center;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:278px;display:flex;flex-direction:column;gap:12px;flex-shrink:0;}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:13px;}
.panel-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--muted);margin-bottom:10px;}
#statusText{font-size:14px;font-weight:600;color:var(--white);background:var(--bg);padding:8px 12px;border-radius:8px;text-align:center;min-height:36px;display:flex;align-items:center;justify-content:center;}
.think-bar{height:3px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:8px;display:none;}
.think-bar.active{display:block;}
.think-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--purple));animation:thinkAnim 1.4s ease-in-out infinite;}
@keyframes thinkAnim{0%{width:0%;margin-left:0%;}50%{width:55%;margin-left:22%;}100%{width:0%;margin-left:100%;}}

/* â”€â”€ MOVE NAME BANNER â”€â”€ */
#moveNameBanner{padding:10px 13px;border-radius:10px;border-left:4px solid var(--gold);background:rgba(245,200,66,0.08);font-size:13px;line-height:1.5;display:none;}
#moveNameBanner.show{display:block;}
.move-name-title{font-weight:700;color:var(--gold);font-size:14px;}
.move-name-desc{color:var(--text);font-size:12px;margin-top:3px;}

/* â”€â”€ GAUGE BAR â”€â”€ */
.gauge-wrap{margin-top:4px;}
.gauge-label-row{display:flex;justify-content:space-between;font-size:10px;font-weight:700;margin-bottom:4px;}
.gauge-label-row .lbl-b{color:#94a3b8;}
.gauge-label-row .lbl-w{color:#fde68a;}
.eval-bar-wrap{height:22px;background:var(--bg);border-radius:6px;overflow:hidden;border:1px solid var(--border);display:flex;}
.eval-bar-white{background:linear-gradient(90deg,#d4a800,#FFFFF0);transition:width 0.5s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:4px;}
.eval-bar-black{background:linear-gradient(90deg,#111,#222);flex:1;display:flex;align-items:center;padding-left:4px;}
.eval-bar-text-w{font-size:9px;font-weight:800;color:#3a2a00;}
.eval-bar-text-b{font-size:9px;font-weight:800;color:#94a3b8;}
.gauge-needle-label{text-align:center;font-size:11px;font-weight:700;margin-top:4px;color:var(--muted);}

/* â”€â”€ MOVE LOG â”€â”€ */
#moveLog{height:200px;overflow-y:auto;font-family:monospace;font-size:12px;line-height:1.9;color:var(--muted);}
#moveLog::-webkit-scrollbar{width:4px;}
#moveLog::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.log-row{display:flex;gap:6px;align-items:baseline;padding:1px 0;}
.log-num{color:var(--muted);width:24px;flex-shrink:0;font-size:11px;}
.log-w{color:var(--white);min-width:70px;}
.log-b{color:#94a3b8;min-width:70px;}
.log-tag{font-size:9px;padding:1px 5px;border-radius:3px;font-family:'Segoe UI',sans-serif;font-weight:700;white-space:nowrap;}
.tag-tactic{background:rgba(239,68,68,0.2);color:#fca5a5;}
.tag-opening{background:rgba(59,130,246,0.2);color:#93c5fd;}
.tag-special{background:rgba(168,85,247,0.2);color:#d8b4fe;}
.tag-strat{background:rgba(20,184,166,0.2);color:#5eead4;}
/* Referee annotation row */
.log-referee{
  display:flex;align-items:flex-start;gap:6px;
  padding:5px 8px;margin:3px 0;
  border-radius:8px;font-family:'Segoe UI',sans-serif;
  font-size:11px;line-height:1.5;
  animation:refSlide 0.3s ease;
}
@keyframes refSlide{from{opacity:0;transform:translateX(-6px);}to{opacity:1;transform:none;}}
.log-referee.blunder{background:rgba(239,68,68,0.12);border-left:3px solid #ef4444;}
.log-referee.mistake{background:rgba(249,115,22,0.1);border-left:3px solid #f97316;}
.log-referee.best{background:rgba(34,197,94,0.08);border-left:3px solid #22c55e;}
.ref-icon{font-size:14px;flex-shrink:0;margin-top:1px;}
.ref-body{flex:1;}
.ref-label{font-weight:800;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;}
.ref-label.blunder{color:#ef4444;}.ref-label.mistake{color:#f97316;}.ref-label.best{color:#22c55e;}
.ref-move{color:var(--text);font-size:11px;}
.ref-best{margin-top:2px;color:#86efac;font-size:10px;font-weight:600;}
.ref-who{font-size:9px;color:var(--muted);margin-right:4px;}

/* â”€â”€ CONTROLS â”€â”€ */
.ctrl-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.btn{padding:8px 10px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:opacity 0.15s,transform 0.1s;display:flex;align-items:center;justify-content:center;gap:5px;}
.btn:hover{opacity:0.85;transform:translateY(-1px);}
.btn:active{transform:translateY(0);opacity:1;}
.btn-full{grid-column:span 2;}
.btn-gold{background:linear-gradient(135deg,#f5c842,#e8a800);color:#000;}
.btn-dark{background:var(--bg3);color:var(--text);border:1px solid var(--border);}
.btn-purple{background:var(--purple);color:#fff;}

/* â”€â”€ STAGE PANEL â”€â”€ */
.stage-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;}
.stage-btn{padding:5px 4px;border-radius:6px;text-align:center;font-size:11px;font-weight:700;cursor:default;border:1px solid var(--border);background:var(--bg3);color:var(--muted);}
.stage-btn.done{background:rgba(245,200,66,0.15);border-color:var(--gold);color:var(--gold);}
.stage-btn.current{background:rgba(59,130,246,0.2);border-color:var(--blue);color:var(--blue);box-shadow:0 0 10px rgba(59,130,246,0.3);}

/* â”€â”€ TRAINING PANEL â”€â”€ */
.training-panel{width:295px;display:flex;flex-direction:column;gap:12px;flex-shrink:0;}
#trainingBox{border-color:rgba(168,85,247,0.4);}
.training-head{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.training-indicator{width:8px;height:8px;border-radius:50%;background:var(--purple);animation:pulse2 2s infinite;}
@keyframes pulse2{0%,100%{opacity:1;}50%{opacity:0.4;}}
.analysis-entry{padding:9px 11px;border-radius:8px;margin-bottom:8px;border-left:3px solid transparent;font-size:12px;line-height:1.6;}
.analysis-entry.blunder{background:rgba(239,68,68,0.1);border-color:#ef4444;}
.analysis-entry.mistake{background:rgba(249,115,22,0.1);border-color:#f97316;}
.analysis-entry.inaccuracy{background:rgba(234,179,8,0.1);border-color:#eab308;}
.analysis-entry.good{background:rgba(34,197,94,0.1);border-color:#22c55e;}
.analysis-entry.best{background:rgba(59,130,246,0.1);border-color:#3b82f6;}
.analysis-badge{font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;display:inline-block;margin-bottom:3px;}
.analysis-badge.blunder{color:#ef4444;}.analysis-badge.mistake{color:#f97316;}
.analysis-badge.inaccuracy{color:#eab308;}.analysis-badge.good{color:#22c55e;}.analysis-badge.best{color:#3b82f6;}
.analysis-text{color:var(--text);font-size:12px;}
.analysis-best{margin-top:5px;padding:5px 9px;background:rgba(34,197,94,0.12);border-radius:5px;font-size:12px;color:#86efac;}

/* â”€â”€ PROMO MODAL â”€â”€ */
#promoModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:999;align-items:center;justify-content:center;}
#promoModal.show{display:flex;}
.promo-box{background:var(--panel);border:2px solid var(--gold);border-radius:16px;padding:26px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.9);}
.promo-box h3{font-size:15px;color:var(--white);margin-bottom:16px;}
.promo-pieces{display:flex;gap:12px;justify-content:center;}
.promo-piece{width:68px;height:68px;background:var(--sq-light);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid transparent;transition:all 0.15s;padding:6px;}
.promo-piece svg{width:100%;height:100%;}
.promo-piece:hover{border-color:var(--gold);transform:scale(1.1);background:#e8d08a;}

/* â”€â”€ TRAINING POPUP â”€â”€ */
#trainingPopup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:998;align-items:center;justify-content:center;padding:20px;}
#trainingPopup.show{display:flex;}
.popup-box{background:var(--panel);border:1px solid rgba(168,85,247,0.5);border-radius:16px;padding:26px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.95);}
.popup-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.popup-icon{font-size:34px;}
.popup-title{font-size:19px;font-weight:800;color:var(--white);}
.popup-subtitle{font-size:12px;color:var(--purple);}
.popup-section{margin-bottom:14px;}
.popup-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);margin-bottom:5px;}
.popup-text{font-size:13px;color:var(--text);line-height:1.65;}
.best-move-highlight{padding:9px 13px;background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);border-radius:8px;font-size:14px;font-weight:700;color:#4ade80;text-align:center;margin:8px 0;}
.wrong-move-highlight{padding:7px 13px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;font-size:13px;font-weight:700;color:#fca5a5;text-align:center;margin:5px 0;}
.popup-btns{display:flex;gap:10px;margin-top:16px;}
.popup-btns .btn{flex:1;padding:11px;font-size:13px;}

/* Training strictness badge */
.strictness-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;background:rgba(168,85,247,0.2);color:#c084fc;border:1px solid rgba(168,85,247,0.3);margin-bottom:10px;}

/* â”€â”€ STAGE UP â”€â”€ */
#stageUp{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:999;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:24px;}
#stageUp.show{display:flex;animation:fadeIn 0.4s;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.stageup-icon{font-size:76px;animation:bounce2 0.8s ease infinite alternate;margin-bottom:14px;}
@keyframes bounce2{from{transform:scale(1);}to{transform:scale(1.15);}}
.stageup-title{font-size:clamp(26px,5vw,50px);font-weight:900;background:linear-gradient(135deg,#f5c842,#e8a800,#f5c842);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px;}
.stageup-next{font-size:17px;color:var(--text);margin-bottom:8px;}
.stageup-msg{font-size:14px;color:var(--muted);max-width:400px;line-height:1.6;margin-bottom:26px;}
.confetti-container{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:1000;}
.confetti-piece{position:absolute;width:10px;height:10px;border-radius:2px;animation:confettiFall linear forwards;}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1;}100%{transform:translateY(110vh) rotate(720deg);opacity:0.2;}}

/* â”€â”€ HOW IT WORKS â”€â”€ */
#howItWorks{background:var(--bg2);border-top:2px solid var(--border);padding:44px 24px;max-width:860px;margin:0 auto;}
#howItWorks h2{font-size:26px;font-weight:900;color:var(--gold);margin-bottom:8px;}
#howItWorks h3{font-size:16px;font-weight:700;color:var(--blue);margin:22px 0 7px;}
#howItWorks p,#howItWorks li{font-size:13.5px;color:var(--text);line-height:1.8;margin-bottom:5px;}
#howItWorks ul{padding-left:18px;}
.tag-s{display:inline-block;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:700;margin-right:3px;}
.tag-storage{background:rgba(59,130,246,0.2);color:#93c5fd;}
.tag-nosql{background:rgba(34,197,94,0.2);color:#86efac;}

::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

@media(max-width:1100px){.training-panel{width:100%;max-width:540px;}}
@media(max-width:900px){
  :root{--sq-size:44px;}
  .sidebar,.training-panel{width:100%;max-width:100%;}
  .game-area{padding:8px;gap:10px;}
  .piece{font-size:30px;}
}
@media(max-width:600px){
  :root{--sq-size:calc((100vw - 48px) / 8);}
  .piece{font-size:calc((100vw - 48px) / 8 * 0.68);}
  .topbar{padding:0 10px;gap:6px;height:46px;flex-wrap:nowrap;overflow:hidden;}
  .topbar-logo{font-size:14px;}
  .topbar-color-badge{display:none;}
  .topbar-mode-badge{font-size:9px;padding:2px 7px;}
  .stage-indicator{font-size:10px;gap:4px;margin-left:4px;}
  .stage-badge{padding:2px 7px;font-size:10px;}
  .btn-home{padding:4px 9px;font-size:11px;margin-left:auto;white-space:nowrap;}
  .board-col{width:100%;align-items:center;}
  .player-bar{width:100% !important;max-width:calc(var(--sq-size)*8 + 22px);}
  .player-name{font-size:11px;}
  .player-rating{font-size:9px;padding:1px 5px;}
  .player-clock{font-size:14px;}
  .player-avatar{width:28px;height:28px;font-size:15px;}
  .player-captures{font-size:13px;}
  .game-area{padding:6px 6px;gap:8px;flex-direction:column;align-items:center;}
  .sidebar,.training-panel{width:100%;max-width:calc(var(--sq-size)*8 + 22px);}
  .ctrl-grid{grid-template-columns:1fr 1fr;}
  .btn-full{grid-column:span 2;}
  .btn{padding:7px 6px;font-size:11px;}
  #moveLog{height:120px;}
  .rank-labels span{font-size:9px;}
  .file-labels span{font-size:9px;}
  .panel{padding:10px;}
  .panel-title{font-size:9px;margin-bottom:7px;}
  #statusText{font-size:12px;padding:6px 10px;}
  /* Mobile sidebar collapsible hints */
  .sidebar > .panel{margin-bottom:0;}
}
@media(max-width:380px){
  :root{--sq-size:calc((100vw - 32px) / 8);}
  .piece{font-size:calc((100vw - 32px) / 8 * 0.65);}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SPLASH â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="splash">
  <div class="splash-logo">â™”</div>
  <div class="splash-title">Prof King Keys Chess</div>
  <div class="splash-subtitle">by Profkingkeys Â· Master the 64 Squares</div>
  <p class="splash-tagline">Premium chess with intelligent training, strict move analysis, and 10 escalating stages to forge a chess expert.</p>

  <!-- PIECE COLOR PICKER -->
  <div class="color-picker-wrap">
    <div class="color-picker-label">Choose your piece color</div>
    <div class="color-options">
      <div class="color-opt selected-w" id="optWhite" onclick="selectColor('w')">
        <span class="color-opt-piece preview-white" id="previewWhite"></span>
        <span class="color-opt-label">White</span>
        <span class="color-opt-sub">You move first</span>
      </div>
      <div class="color-opt" id="optBlack" onclick="selectColor('b')">
        <span class="color-opt-piece preview-black" id="previewBlack"></span>
        <span class="color-opt-label">Black</span>
        <span class="color-opt-sub">Bot moves first</span>
      </div>
    </div>
  </div>

  <div class="mode-cards">
    <div class="mode-card" onclick="startMode('game')">
      <div class="mode-icon">âš”ï¸</div>
      <div class="mode-name">Game Mode</div>
      <div class="mode-desc">Play vs bot across 10 stages. Win to advance. Live position gauge shows who's winning.</div>
    </div>
    <div class="mode-card training-card" onclick="startMode('training')">
      <div class="mode-icon">ğŸ“</div>
      <div class="mode-name">Training Mode</div>
      <div class="mode-desc">Zero-tolerance 2000-rated coach. Every blunder, mistake and inaccuracy is stopped, explained, and shown with an arrow.</div>
    </div>
  </div>

  <div style="font-size:11px;color:var(--muted);margin-bottom:10px;">Stage progress</div>
  <div class="splash-stages" id="splashStages"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
  <div class="topbar">
    <span class="topbar-logo">â™” Prof King Keys</span>
    <span class="topbar-mode-badge" id="modeBadge">Game</span>
    <span class="topbar-color-badge" id="colorBadge">â¬œ White</span>
    <span class="stage-indicator">Stage <span class="stage-badge" id="stageLabel">1</span></span>
    <button class="btn-home" onclick="goHome()">âŒ‚ Menu</button>
  </div>

  <div class="game-area">
    <!-- Board column -->
    <div class="board-col">
      <!-- Top player bar (opponent) -->
      <div class="player-bar" id="barTop">
        <div class="player-avatar" id="topAvatar">ğŸ¤–</div>
        <div>
          <div class="player-name" id="topName">Bot</div>
          <div class="player-rating" id="topRating">500</div>
        </div>
        <div class="player-captures" id="capturedByTop"></div>
        <div class="player-clock" id="topClock">â€”</div>
      </div>

      <div class="board-wrapper">
        <div class="rank-labels" id="rankLabels"></div>
        <div class="col-wrap">
          <div class="board-frame" style="position:relative;">
            <div id="board"></div>
            <canvas id="arrowCanvas"></canvas>
            <div id="gameOverlay">
              <h2 id="overlayTitle">â™Ÿ</h2>
              <p id="overlayMsg"></p>
              <div class="overlay-btns">
                <button class="btn btn-gold" onclick="newGame()">New Game</button>
                <button class="btn btn-dark" onclick="goHome()">Menu</button>
              </div>
            </div>
          </div>
          <div class="file-labels" id="fileLabels"></div>
        </div>
      </div>

      <!-- Bottom player bar (you) -->
      <div class="player-bar" id="barBottom">
        <div class="player-avatar" id="bottomAvatar">ğŸ‘‘</div>
        <div>
          <div class="player-name" id="bottomName">You</div>
          <div class="player-rating" id="bottomRating">2000+</div>
        </div>
        <div class="player-captures" id="capturedByBottom"></div>
        <div class="player-clock" id="bottomClock">â€”</div>
      </div>
    </div>

    <!-- Right sidebar -->
    <div class="sidebar">
      <div class="panel">
        <div class="panel-title">Game Status</div>
        <div id="statusText">Your turn</div>
        <div class="think-bar" id="thinkBar"><div class="think-fill"></div></div>
      </div>

      <div id="moveNameBanner">
        <div class="move-name-title" id="moveNameTitle"></div>
        <div class="move-name-desc" id="moveNameDesc"></div>
      </div>

      <!-- Gauge â€” always visible -->
      <div class="panel">
        <div class="panel-title">Position Gauge âš–ï¸</div>
        <div class="gauge-wrap">
          <div class="gauge-label-row">
            <span class="lbl-b" id="gaugeLabelBlack">â—¼ Black</span>
            <span class="lbl-w" id="gaugeLabelWhite">White â—»</span>
          </div>
          <div class="eval-bar-wrap">
            <div class="eval-bar-white" id="evalBarWhite" style="width:50%;">
              <span class="eval-bar-text-w" id="evalTextW"></span>
            </div>
            <div class="eval-bar-black">
              <span class="eval-bar-text-b" id="evalTextB"></span>
            </div>
          </div>
          <div class="gauge-needle-label" id="evalLabel">Equal âš–ï¸</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Move History</div>
        <div id="moveLog"></div>
      </div>

      <div class="panel">
        <div class="panel-title">Stage Progress</div>
        <div class="stage-grid" id="stageGrid"></div>
        <div style="font-size:11px;color:var(--muted);margin-top:8px;line-height:1.5;" id="stageDesc"></div>
      </div>

      <div class="panel">
        <div class="panel-title">Controls</div>
        <div class="ctrl-grid">
          <button class="btn btn-gold btn-full" onclick="newGame()">ğŸ”„ New Game</button>
          <button class="btn btn-dark" onclick="undoMove()">â†© Undo</button>
          <button class="btn btn-dark" onclick="flipBoard()">â‡… Flip</button>
        </div>
      </div>
    </div>

    <!-- Training panel -->
    <div class="training-panel" id="trainingPanel" style="display:none;">
      <div class="panel" id="trainingBox">
        <div class="training-head">
          <div class="training-indicator"></div>
          <div><div class="panel-title" style="margin:0;">Training Analysis</div></div>
        </div>
        <div class="strictness-badge">ğŸ¯ 2000-Rated Coach â€” Zero Tolerance</div>
        <div id="analysisLog"></div>
        <div class="gauge-wrap" style="margin-top:8px;">
          <div class="gauge-label-row">
            <span class="lbl-b">â—¼ Black</span>
            <span class="lbl-w">White â—»</span>
          </div>
          <div class="eval-bar-wrap">
            <div class="eval-bar-white" id="tEvalBarWhite" style="width:50%;"></div>
            <div class="eval-bar-black" id="tEvalBarBlack"></div>
          </div>
          <div class="gauge-needle-label" id="tEvalLabel">Equal âš–ï¸</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• HOW IT WORKS â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="howItWorks">
  <h2>âš™ï¸ How Prof King Keys Chess Works</h2>
  <p>A fully self-contained, single HTML file â€” no server, no database, no install required after first load.</p>

  <h3>â™™ White vs Black Pieces â€” True 3D</h3>
  <p>White pieces use pure ivory (#FFFFF0) with a dark brown text-stroke, a warm gold glow aura, and layered text-shadows that simulate a top highlight (dome effect) plus a bottom drop shadow â€” creating a genuine 3D raised appearance. Black pieces use near-black (#0d0d0d) with a grey rim and a subtle cool-light top reflection, making them look like polished obsidian. No images â€” all done in CSS.</p>

  <h3>ğŸ¨ Piece Color Selection</h3>
  <p>On the splash screen you choose White or Black before starting. If you choose Black, you play as Black and the bot (playing White) makes the first move automatically. The board flips so your pieces are always at the bottom. Your choice is remembered for the session.</p>

  <h3>ğŸ“ Training Mode â€” 2000-Rated Zero-Tolerance Coach</h3>
  <p>The trainer uses a depth-5 engine search to find the best move before you commit yours. It also runs a real-time tactical check â€” if your moved piece is immediately capturable for free (hanging), it's flagged as a blunder regardless of the static eval. This catches hanging bishops, knights walking into pawns, and any material-losing move a 2000-rated player would never play. The centipawn thresholds:</p>
  <ul>
    <li><strong>Best/Excellent (0â€“15cp):</strong> You found the top or an equally strong move. âœ…</li>
    <li><strong>Inaccuracy (16â€“50cp):</strong> Slightly weaker â€” flagged with explanation. ğŸ’¡</li>
    <li><strong>Mistake (51â€“150cp):</strong> Meaningfully worse â€” stopped and corrected. âš ï¸</li>
    <li><strong>Blunder (&gt;150cp or hanging piece):</strong> Serious error â€” stopped, red highlighted, arrow shown. ğŸš¨</li>
  </ul>
  <p>Every flagged move shows: your wrong square (red), the best destination (green), an animated board arrow from the best piece to its square, and a written explanation of both why your move was wrong and why the best move is right.</p>

  <h3>ğŸ“Š Position Gauge</h3>
  <p>Available in both modes. The evaluation function counts material (Queen=9, Rook=5, Bishop/Knightâ‰ˆ3.2, Pawn=1) plus piece-square table bonuses for control and positioning. The gauge maps centipawn score to a visual bar using a capped sigmoid, so a +3 pawn advantage shows clearly without pegging the bar at 100%.</p>

  
<!-- â•â•â•â•â•â•â•â•â•â•â•â• PROMOTION MODAL â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="promoModal">
  <div class="promo-box">
    <h3>ğŸ‘‘ Promote Pawn</h3>
    <div class="promo-pieces" id="promoPieces"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• TRAINING POPUP â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="trainingPopup">
  <div class="popup-box">
    <div class="popup-header">
      <div class="popup-icon" id="popupIcon">âš ï¸</div>
      <div>
        <div class="popup-title" id="popupTitle">Move Flagged</div>
        <div class="popup-subtitle" id="popupSubtitle">2000-Rated Coach Analysis</div>
      </div>
    </div>
    <div class="popup-section">
      <div class="popup-section-title">âŒ Your Move</div>
      <div class="wrong-move-highlight" id="popupYourMoveHL"></div>
      <div class="popup-text" id="popupYourMove"></div>
    </div>
    <div class="popup-section">
      <div class="popup-section-title">âœ… Best Move (shown on board with arrow)</div>
      <div class="best-move-highlight" id="popupBestMove"></div>
      <div class="popup-text" id="popupWhyBest"></div>
    </div>
    <div class="popup-btns">
      <button class="btn btn-purple" onclick="applyBestMove()">â–¶ Play Best Move</button>
      <button class="btn btn-dark" onclick="dismissTraining()">Continue Anyway</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• STAGE UP â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="stageUp">
  <div class="confetti-container" id="confettiContainer"></div>
  <div class="stageup-icon">ğŸ†</div>
  <div class="stageup-title" id="stageUpTitle">Stage Complete!</div>
  <div class="stageup-next" id="stageUpNext">Advancing to Stage 2</div>
  <div class="stageup-msg" id="stageUpMsg"></div>
  <button class="btn btn-gold" style="padding:13px 34px;font-size:15px;" onclick="advanceStage()">Continue â–¶</button>
</div>

<script>
if(typeof Chess==='undefined'){document.body.innerHTML='<p style="color:red;padding:40px;font-size:18px;">chess.js CDN failed to load. Check internet and reload.</p>';throw new Error('chess.js not loaded');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   CONSTANTS & CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PIECES_UNICODE={wk:'â™”',wq:'â™•',wr:'â™–',wb:'â™—',wn:'â™˜',wp:'â™™',bk:'â™š',bq:'â™›',br:'â™œ',bb:'â™',bn:'â™',bp:'â™Ÿ'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   KINGDOM WAR PIECES â€” Heraldic battle style
//   White Kingdom: ivory/gold â€” noble army
//   Dark Kingdom: obsidian/crimson â€” shadow army
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const W={fill:'#F2ECD9',stroke:'#3a2600',hl:'#FFFFFF',shade:'#C8A96E',accent:'#D4AF37'};
const B={fill:'#2A2A3A',stroke:'#111',hl:'#6A6A8A',shade:'#111122',accent:'#8B0000'};

function makeSVG(c,paths){
  const p=c==='w'?W:B;
  return `<svg viewBox="0 0 45 45" xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
    <defs>
      <filter id="ps${c}"><feDropShadow dx="0" dy="2" stdDeviation="1.5" flood-color="${c==='w'?'rgba(0,0,0,0.5)':'rgba(0,0,0,0.8)'}" flood-opacity="1"/></filter>
      <linearGradient id="wg${c}" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="${p.hl}" stop-opacity="0.7"/>
        <stop offset="50%" stop-color="${p.fill}"/>
        <stop offset="100%" stop-color="${p.shade}"/>
      </linearGradient>
    </defs>
    <g filter="url(#ps${c})">${paths(p)}</g>
  </svg>`;
}

// KING â€” crowned monarch with cross scepter
const SVG_PIECES={
wk:makeSVG('w',p=>`
  <rect x="17" y="2" width="11" height="3.5" rx="1.5" fill="${p.fill}" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="20.5" y="1" width="4" height="6" rx="1" fill="${p.fill}" stroke="${p.stroke}" stroke-width="1"/>
  <path d="M13 10 Q14 7 22.5 6 Q31 7 32 10 L34 18 Q30 15 22.5 15 Q15 15 11 18 Z" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <rect x="14" y="17" width="17" height="3" rx="1" fill="${p.accent}" stroke="${p.stroke}" stroke-width="1"/>
  <path d="M11 20 Q11 38 22.5 39 Q34 38 34 20 Z" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M13 28 Q22.5 32 32 28" fill="none" stroke="${p.accent}" stroke-width="1.2" opacity="0.7"/>
  <ellipse cx="22.5" cy="39" rx="11" ry="3.5" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
`),
bk:makeSVG('b',p=>`
  <rect x="17" y="2" width="11" height="3.5" rx="1.5" fill="${p.fill}" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="20.5" y="1" width="4" height="6" rx="1" fill="${p.fill}" stroke="${p.stroke}" stroke-width="1"/>
  <path d="M13 10 Q14 7 22.5 6 Q31 7 32 10 L34 18 Q30 15 22.5 15 Q15 15 11 18 Z" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <rect x="14" y="17" width="17" height="3" rx="1" fill="${p.accent}" stroke="${p.stroke}" stroke-width="1"/>
  <path d="M11 20 Q11 38 22.5 39 Q34 38 34 20 Z" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M13 28 Q22.5 32 32 28" fill="none" stroke="${p.accent}" stroke-width="1.2" opacity="0.6"/>
  <ellipse cx="22.5" cy="39" rx="11" ry="3.5" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
`),

// QUEEN â€” regal with 5-pointed crown
wq:makeSVG('w',p=>`
  <path d="M7 12 L11 6 L16 11 L22.5 4 L29 11 L34 6 L38 12 L34 22 Q30 19 22.5 19 Q15 19 11 22 Z" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <rect x="13" y="21" width="19" height="3.5" rx="1" fill="${p.accent}" stroke="${p.stroke}" stroke-width="1"/>
  <path d="M11 24.5 L11 37 Q22.5 40 34 37 L34 24.5 Z" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M13 30 Q22.5 33 32 30" fill="none" stroke="${p.accent}" stroke-width="1.1" opacity="0.7"/>
  <ellipse cx="22.5" cy="38" rx="11.5" ry="3" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
  <circle cx="7" cy="12" r="2" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
  <circle cx="38" cy="12" r="2" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
  <circle cx="22.5" cy="4" r="2" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
`),
bq:makeSVG('b',p=>`
  <path d="M7 12 L11 6 L16 11 L22.5 4 L29 11 L34 6 L38 12 L34 22 Q30 19 22.5 19 Q15 19 11 22 Z" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <rect x="13" y="21" width="19" height="3.5" rx="1" fill="${p.accent}" stroke="${p.stroke}" stroke-width="1"/>
  <path d="M11 24.5 L11 37 Q22.5 40 34 37 L34 24.5 Z" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M13 30 Q22.5 33 32 30" fill="none" stroke="${p.accent}" stroke-width="1.1" opacity="0.5"/>
  <ellipse cx="22.5" cy="38" rx="11.5" ry="3" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
  <circle cx="7" cy="12" r="2" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
  <circle cx="38" cy="12" r="2" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
  <circle cx="22.5" cy="4" r="2" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
`),

// ROOK â€” tower fortress with battlements
wr:makeSVG('w',p=>`
  <rect x="12" y="4" width="5" height="8" rx="1" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="20" y="4" width="5" height="8" rx="1" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="28" y="4" width="5" height="8" rx="1" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="10" y="11" width="25" height="5" rx="1" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="11" y="16" width="23" height="19" rx="1.5" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <rect x="14" y="20" width="5" height="9" rx="1" fill="${p.shade}" stroke="${p.stroke}" stroke-width="0.8" opacity="0.7"/>
  <rect x="26" y="20" width="5" height="9" rx="1" fill="${p.shade}" stroke="${p.stroke}" stroke-width="0.8" opacity="0.7"/>
  <ellipse cx="22.5" cy="36.5" rx="12" ry="3.5" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
`),
br:makeSVG('b',p=>`
  <rect x="12" y="4" width="5" height="8" rx="1" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="20" y="4" width="5" height="8" rx="1" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="28" y="4" width="5" height="8" rx="1" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="10" y="11" width="25" height="5" rx="1" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.2"/>
  <rect x="11" y="16" width="23" height="19" rx="1.5" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <rect x="14" y="20" width="5" height="9" rx="1" fill="${p.shade}" stroke="${p.stroke}" stroke-width="0.8" opacity="0.8"/>
  <rect x="26" y="20" width="5" height="9" rx="1" fill="${p.shade}" stroke="${p.stroke}" stroke-width="0.8" opacity="0.8"/>
  <ellipse cx="22.5" cy="36.5" rx="12" ry="3.5" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
`),

// BISHOP â€” hooded cleric with mitre hat
wb:makeSVG('w',p=>`
  <ellipse cx="22.5" cy="8" rx="5" ry="7" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.2"/>
  <path d="M20 6 L22.5 2 L25 6" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
  <ellipse cx="22.5" cy="13" rx="7" ry="3" fill="${p.fill}" stroke="${p.stroke}" stroke-width="1.1"/>
  <path d="M15.5 15 Q16 13 22.5 13 Q29 13 29.5 15 L31 35 Q26 37 22.5 37 Q19 37 14 35 Z" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M17 22 Q22.5 25 28 22" fill="none" stroke="${p.accent}" stroke-width="1" opacity="0.7"/>
  <path d="M22.5 16 L22.5 32" stroke="${p.accent}" stroke-width="1" opacity="0.5"/>
  <path d="M17 24 L28 24" stroke="${p.accent}" stroke-width="1" opacity="0.5"/>
  <ellipse cx="22.5" cy="36" rx="10" ry="3" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
`),
bb:makeSVG('b',p=>`
  <ellipse cx="22.5" cy="8" rx="5" ry="7" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.2"/>
  <path d="M20 6 L22.5 2 L25 6" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
  <ellipse cx="22.5" cy="13" rx="7" ry="3" fill="${p.fill}" stroke="${p.stroke}" stroke-width="1.1"/>
  <path d="M15.5 15 Q16 13 22.5 13 Q29 13 29.5 15 L31 35 Q26 37 22.5 37 Q19 37 14 35 Z" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M17 22 Q22.5 25 28 22" fill="none" stroke="${p.accent}" stroke-width="1" opacity="0.5"/>
  <path d="M22.5 16 L22.5 32" stroke="${p.accent}" stroke-width="1" opacity="0.4"/>
  <path d="M17 24 L28 24" stroke="${p.accent}" stroke-width="1" opacity="0.4"/>
  <ellipse cx="22.5" cy="36" rx="10" ry="3" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
`),

// KNIGHT â€” armored warhorse head with plume
wn:makeSVG('w',p=>`
  <path d="M22 4 Q26 3 28 7 Q32 6 33 10 Q36 13 34 18 Q33 22 30 24 L28 35 L17 35 L16 22 Q10 18 11 12 Q13 7 18 5 Q20 4 22 4 Z" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M22 4 Q24 1 27 3" fill="none" stroke="${p.accent}" stroke-width="2" stroke-linecap="round"/>
  <circle cx="28" cy="10" r="2" fill="${p.shade}" stroke="${p.stroke}" stroke-width="0.8"/>
  <path d="M13 17 Q16 14 20 16" fill="none" stroke="${p.stroke}" stroke-width="1.2"/>
  <path d="M16 20 Q18 19 21 20" fill="none" stroke="${p.stroke}" stroke-width="1"/>
  <path d="M17 35 L28 35" stroke="${p.stroke}" stroke-width="0.5"/>
  <ellipse cx="22.5" cy="37" rx="10" ry="3.5" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
`),
bn:makeSVG('b',p=>`
  <path d="M22 4 Q26 3 28 7 Q32 6 33 10 Q36 13 34 18 Q33 22 30 24 L28 35 L17 35 L16 22 Q10 18 11 12 Q13 7 18 5 Q20 4 22 4 Z" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M22 4 Q24 1 27 3" fill="none" stroke="${p.accent}" stroke-width="2" stroke-linecap="round"/>
  <circle cx="28" cy="10" r="2" fill="${p.shade}" stroke="${p.stroke}" stroke-width="0.8"/>
  <path d="M13 17 Q16 14 20 16" fill="none" stroke="${p.hl}" stroke-width="1.2"/>
  <path d="M16 20 Q18 19 21 20" fill="none" stroke="${p.hl}" stroke-width="1"/>
  <path d="M17 35 L28 35" stroke="${p.stroke}" stroke-width="0.5"/>
  <ellipse cx="22.5" cy="37" rx="10" ry="3.5" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.2"/>
`),

// PAWN â€” armored footsoldier with round shield
wp:makeSVG('w',p=>`
  <circle cx="22.5" cy="10" r="7" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <circle cx="22.5" cy="10" r="3.5" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
  <rect x="19" y="17" width="7" height="2" rx="1" fill="${p.fill}" stroke="${p.stroke}" stroke-width="0.8"/>
  <path d="M15 19 Q15 35 22.5 36 Q30 35 30 19 Z" fill="url(#wgw)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M17 26 Q22.5 29 28 26" fill="none" stroke="${p.accent}" stroke-width="1" opacity="0.6"/>
  <ellipse cx="22.5" cy="37" rx="9" ry="3" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.1"/>
`),
bp:makeSVG('b',p=>`
  <circle cx="22.5" cy="10" r="7" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <circle cx="22.5" cy="10" r="3.5" fill="${p.accent}" stroke="${p.stroke}" stroke-width="0.8"/>
  <rect x="19" y="17" width="7" height="2" rx="1" fill="${p.fill}" stroke="${p.stroke}" stroke-width="0.8"/>
  <path d="M15 19 Q15 35 22.5 36 Q30 35 30 19 Z" fill="url(#wgb)" stroke="${p.stroke}" stroke-width="1.3"/>
  <path d="M17 26 Q22.5 29 28 26" fill="none" stroke="${p.accent}" stroke-width="1" opacity="0.5"/>
  <ellipse cx="22.5" cy="37" rx="9" ry="3" fill="${p.shade}" stroke="${p.stroke}" stroke-width="1.1"/>
`),
};

function getPieceSVG(colorType){
  return SVG_PIECES[colorType]||'';
}

// STAGES â€” Balanced for speed + challenge. Depth capped at 4 for UI responsiveness.
// Bot responds in ~0.1-0.5s instead of 3-5s. Training analysis uses depth 3 always.
const STAGES=[
  {depth:3,noise:0.08,desc:'Club player ~1600. Makes tactical errors you can exploit.'},
  {depth:3,noise:0.04,desc:'Solid club player ~1750. Occasional missed tactics.'},
  {depth:3,noise:0.01,desc:'Expert ~1900. Sharp tactical awareness.'},
  {depth:4,noise:0.02,desc:'Expert+ ~2000. Very rarely misses material.'},
  {depth:4,noise:0.008,desc:'Candidate master ~2100. Principled and accurate.'},
  {depth:4,noise:0.002,desc:'National master ~2200. Precise and relentless.'},
  {depth:4,noise:0,desc:'IM level ~2350. Almost no tactical errors.'},
  {depth:4,noise:0,desc:'FIDE Master ~2450. Every move has purpose.'},
  {depth:4,noise:0,desc:'Grandmaster territory ~2550. Near-perfect play.'},
  {depth:4,noise:0,desc:'Super GM ~2600. Peak engine. Good luck.'}
];

const PV={p:100,n:320,b:330,r:500,q:900,k:20000};
const PST={
  p:[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],
  n:[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],
  b:[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,10,10,5,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],
  r:[[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]],
  q:[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,5,5,5,5,5,0,-10],[-10,0,5,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],
  k:[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]]
};

const OPENING_BOOK={
  'e4':{name:"King's Pawn Opening",tag:'opening'},'d4':{name:"Queen's Pawn Opening",tag:'opening'},
  'c4':{name:'English Opening',tag:'opening'},'Nf3':{name:'RÃ©ti Opening',tag:'opening'},
  'e4 e5':{name:'Open Game',tag:'opening'},'e4 c5':{name:'Sicilian Defence',tag:'opening'},
  'e4 e6':{name:'French Defence',tag:'opening'},'e4 c6':{name:'Caro-Kann Defence',tag:'opening'},
  'e4 d5':{name:'Scandinavian Defence',tag:'opening'},'e4 Nf6':{name:"Alekhine's Defence",tag:'opening'},
  'd4 d5':{name:'Closed Game',tag:'opening'},'d4 Nf6':{name:'Indian Defence',tag:'opening'},
  'd4 f5':{name:'Dutch Defence',tag:'opening'},
  'e4 e5 Nf3':{name:"King's Knight Opening",tag:'opening'},
  'e4 e5 Nf3 Nc6 Bb5':{name:'Ruy LÃ³pez (Spanish Game)',tag:'opening'},
  'e4 e5 Nf3 Nc6 Bc4':{name:'Italian Game',tag:'opening'},
  'e4 e5 Nf3 Nc6 d4':{name:'Scotch Game',tag:'opening'},
  'e4 e5 f4':{name:"King's Gambit",tag:'opening'},
  'd4 d5 c4':{name:"Queen's Gambit",tag:'opening'},
  'd4 Nf6 c4 g6':{name:"King's Indian Defence",tag:'opening'},
  'd4 Nf6 c4 c5':{name:'Benoni Defence',tag:'opening'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let game=new Chess();
let currentMode='game';
let currentStage=0;
let playerColor='w';  // 'w' or 'b' â€” chosen on splash
let PLAYER='w';       // updated when color chosen
let BOT='b';
let stagesComplete=JSON.parse(localStorage.getItem('pkc_stages')||'[false,false,false,false,false,false,false,false,false,false]');
let flipped=false;
let selected=null;
let legalDests={};
let lastFrom=null;
let lastTo=null;
let botBusy=false;
let pendingPromo=null;
let moveHistory=[];
let pendingTrainingFix=null;
let pendingGameAnnotation=null; // for game mode silent referee analysis

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   COLOR PICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectColor(c){
  playerColor=c;
  PLAYER=c;
  BOT=c==='w'?'b':'w';
  document.getElementById('optWhite').className='color-opt'+(c==='w'?' selected-w':'');
  document.getElementById('optBlack').className='color-opt'+(c==='b'?' selected-b':'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function evaluate(g){
  if(g.in_checkmate())return g.turn()==='w'?-999999:999999;
  if(g.in_stalemate()||g.in_draw())return 0;
  let score=0;
  const board=g.board();
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const p=board[r][c];
    if(!p)continue;
    const pr=p.color==='w'?r:7-r;
    const pst=PST[p.type]?(PST[p.type][pr]?PST[p.type][pr][c]:0):0;
    score+=p.color==='w'?(PV[p.type]+pst):-(PV[p.type]+pst);
  }
  return score;
}
function orderMoves(moves){
  return moves.slice().sort((a,b)=>{
    const val=m=>{let v=0;if(m.captured)v+=10*(PV[m.captured]||0)-(PV[m.piece]||0);if(m.promotion)v+=PV[m.promotion]||0;return v;};
    return val(b)-val(a);
  });
}
function negamax(g,depth,alpha,beta){
  if(g.game_over()){const raw=evaluate(g);return g.turn()==='w'?raw:-raw;}
  if(depth===0){const raw=evaluate(g);return g.turn()==='w'?raw:-raw;}
  const moves=orderMoves(g.moves({verbose:true}));
  let best=-Infinity;
  for(const m of moves){
    g.move(m);
    const score=-negamax(g,depth-1,-beta,-alpha);
    g.undo();
    if(score>best)best=score;
    if(score>alpha)alpha=score;
    if(alpha>=beta)break;
  }
  return best;
}

// Fast sync search for training analysis (depth capped at 3 for speed)
function findBestMoveSync(g,depth,noise=0){
  const moves=orderMoves(g.moves({verbose:true}));
  if(!moves.length)return null;
  let bestMove=null,bestScore=-Infinity;
  const scores=[];
  for(const m of moves){
    g.move(m);
    const score=-negamax(g,depth-1,-Infinity,Infinity);
    g.undo();
    scores.push({m,score});
    if(score>bestScore){bestScore=score;bestMove=m;}
  }
  if(noise>0&&Math.random()<noise*2){
    const threshold=bestScore-150;
    const candidates=scores.filter(s=>s.score>=threshold);
    const pick=candidates[Math.floor(Math.random()*candidates.length)];
    return pick?pick.m:bestMove;
  }
  return bestMove;
}

// Legacy alias
function findBestMove(g,depth,noise=0){return findBestMoveSync(g,depth,noise);}

// Async bot move using chunked setTimeout to avoid blocking UI
function findBestMoveAsync(fenStr, depth, noise, callback){
  setTimeout(()=>{
    const g=new Chess(fenStr);
    const result=findBestMoveSync(g,depth,noise);
    callback(result);
  },0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   MOVE NAME DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function detectMoveName(gbefore,move){
  if(!move)return null;
  if(move.flags&&move.flags.includes('k'))return{name:'Kingside Castle O-O',desc:'King safely tucked behind the kingside rook.',tag:'special'};
  if(move.flags&&move.flags.includes('q'))return{name:'Queenside Castle O-O-O',desc:'King behind the queenside rook â€” rook activates!',tag:'special'};
  if(move.flags&&move.flags.includes('e'))return{name:'En Passant! âœ¨',desc:'Rare pawn capture on the passing square.',tag:'special'};
  if(move.flags&&move.flags.includes('p')){const pn={q:'Queen',r:'Rook',b:'Bishop',n:'Knight'};return{name:`Promotion â†’ ${pn[move.promotion]||''}! ğŸ‘‘`,desc:'Pawn reaches the back rank!',tag:'special'};}
  const gAfter=new Chess(gbefore.fen());
  gAfter.move({from:move.from,to:move.to,promotion:move.promotion||'q'});
  if(gAfter.in_check())return{name:'Check! âš¡',desc:'The king is in check and must respond.',tag:'tactic'};
  const fork=detectFork(gbefore,move);if(fork)return fork;
  const pin=detectPin(gbefore,move);if(pin)return pin;
  const skewer=detectSkewer(gbefore,move);if(skewer)return skewer;
  const disc=detectDiscoveredAttack(gbefore,move);if(disc)return disc;
  const back=detectBackRank(gAfter,move);if(back)return back;
  if(move.piece==='b'){const to=move.to;if(to==='b2'||to==='g2'||to==='b7'||to==='g7')return{name:'Fianchetto! ğŸ°',desc:'Bishop on the long diagonal â€” powerful setup.',tag:'strat'};}
  const sac=detectSacrifice(gbefore,move);if(sac)return sac;
  const moveList=gbefore.history();
  const key=[...moveList,move.san].slice(-5).join(' ');
  for(const[pattern,info]of Object.entries(OPENING_BOOK)){if(key.endsWith(pattern)||key===pattern)return{name:info.name,desc:'Classic opening theory.',tag:info.tag};}
  if(OPENING_BOOK[move.san])return{name:OPENING_BOOK[move.san].name,desc:'Classic first move.',tag:OPENING_BOOK[move.san].tag};
  if(move.piece==='n'){const r=parseInt(move.to[1]);if((move.color==='w'&&r>=5)||(move.color==='b'&&r<=4))return{name:'Knight Outpost ğŸ´',desc:'Knight on an advanced square â€” hard to dislodge.',tag:'strat'};}
  if(move.piece==='r'){const r=parseInt(move.to[1]);if((move.color==='w'&&r===7)||(move.color==='b'&&r===2))return{name:'Rook on 7th! ğŸ´',desc:'Rook invades the 7th rank â€” devastating!',tag:'strat'};}
  return null;
}
function detectFork(g,move){
  const gCopy=new Chess(g.fen());
  if(!gCopy.move({from:move.from,to:move.to,promotion:move.promotion||'q'}))return null;
  const opp=move.color==='w'?'b':'w';
  const board=gCopy.board();
  const pn={p:'Pawn',n:'Knight',b:'Bishop',r:'Rook',q:'Queen',k:'King'};
  const toF=move.to.charCodeAt(0)-97,toR=parseInt(move.to[1])-1;
  const attacked=[];
  if(move.piece==='n'){const km=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]];for(const[df,dr]of km){const f=toF+df,r=toR+dr;if(f>=0&&f<8&&r>=0&&r<8){const p=board[7-r][f];if(p&&p.color===opp&&p.type!=='p')attacked.push(p.type);}}}
  if(attacked.length>=2)return{name:`Knight Fork! âš”ï¸`,desc:`Attacks ${attacked.slice(0,2).map(t=>pn[t]).join(' and ')} at once!`,tag:'tactic'};
  return null;
}
function detectPin(g,move){
  const gCopy=new Chess(g.fen());
  if(!gCopy.move({from:move.from,to:move.to,promotion:move.promotion||'q'}))return null;
  if(move.piece!=='b'&&move.piece!=='r'&&move.piece!=='q')return null;
  const opp=move.color==='w'?'b':'w';
  const board=gCopy.board();
  const ff=move.to.charCodeAt(0)-97,fr=parseInt(move.to[1])-1;
  const dirs=move.piece==='r'?[[0,1],[0,-1],[1,0],[-1,0]]:move.piece==='b'?[[1,1],[1,-1],[-1,1],[-1,-1]]:[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];
  for(const[df,dr]of dirs){
    let f=ff+df,r=fr+dr,first=null;
    while(f>=0&&f<8&&r>=0&&r<8){
      const p=board[7-r][f];
      if(p){
        if(p.color===opp){
          if(!first){if(p.type!=='k')first={t:p.type};else break;}
          else{const pn={p:'Pawn',n:'Knight',b:'Bishop',r:'Rook',q:'Queen'};if(p.type==='k')return{name:'Absolute Pin! ğŸ“Œ',desc:`The ${pn[first.t]} is pinned to the king â€” cannot move!`,tag:'tactic'};if(p.type==='q')return{name:'Relative Pin! ğŸ“Œ',desc:`The ${pn[first.t]||'piece'} is pinned to the Queen.`,tag:'tactic'};break;}
        }else break;
      }
      f+=df;r+=dr;
    }
  }
  return null;
}
function detectSkewer(g,move){
  if(move.piece!=='b'&&move.piece!=='r'&&move.piece!=='q')return null;
  const gCopy=new Chess(g.fen());
  if(!gCopy.move({from:move.from,to:move.to,promotion:move.promotion||'q'}))return null;
  const opp=move.color==='w'?'b':'w';
  const board=gCopy.board();
  const ff=move.to.charCodeAt(0)-97,fr=parseInt(move.to[1])-1;
  const dirs=move.piece==='r'?[[0,1],[0,-1],[1,0],[-1,0]]:move.piece==='b'?[[1,1],[1,-1],[-1,1],[-1,-1]]:[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];
  for(const[df,dr]of dirs){
    let f=ff+df,r=fr+dr,first=null;
    while(f>=0&&f<8&&r>=0&&r<8){
      const p=board[7-r][f];
      if(p){
        if(p.color===opp){
          if(!first){if(p.type==='k'||p.type==='q')first={t:p.type};else break;}
          else{if((PV[p.type]||0)<(PV[first.t]||0))return{name:'Skewer! ğŸ¯',desc:`The ${first.t==='k'?'King':'Queen'} must move, exposing the piece behind!`,tag:'tactic'};break;}
        }else break;
      }
      f+=df;r+=dr;
    }
  }
  return null;
}
function detectDiscoveredAttack(g,move){
  const gAfter=new Chess(g.fen());
  if(!gAfter.move({from:move.from,to:move.to,promotion:move.promotion||'q'}))return null;
  const color=move.color,opp=color==='w'?'b':'w';
  const board=gAfter.board();
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const p=board[r][c];
    if(!p||p.color!==color||!(p.type==='q'||p.type==='r'||p.type==='b'))continue;
    const sq=String.fromCharCode(97+c)+(8-r);
    if(sq===move.to)continue;
    if(countAttacks(gAfter,sq,color,opp)>countAttacks(g,sq,color,opp)){const pn={q:'Queen',r:'Rook',b:'Bishop'};return{name:'Discovered Attack! âš¡',desc:`Moving reveals the ${pn[p.type]}'s attack â€” two threats at once!`,tag:'tactic'};}
  }
  return null;
}
function countAttacks(g,sq,color,opp){
  const board=g.board(),p=g.get(sq);
  if(!p)return 0;
  const file=sq.charCodeAt(0)-97,rank=parseInt(sq[1])-1;
  let count=0;
  const dirs=p.type==='r'?[[0,1],[0,-1],[1,0],[-1,0]]:p.type==='b'?[[1,1],[1,-1],[-1,1],[-1,-1]]:p.type==='q'?[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]:[];
  for(const[df,dr]of dirs){
    let f=file+df,r=rank+dr;
    while(f>=0&&f<8&&r>=0&&r<8){const t=board[7-r][f];if(t){if(t.color===opp&&(PV[t.type]||0)>=PV.n)count++;break;}f+=df;r+=dr;}
  }
  return count;
}
function detectBackRank(gAfter,move){
  if(!gAfter.in_check()){const opp=move.color==='w'?'b':'w';const br=opp==='b'?'8':'1';if(move.to[1]===br&&(move.piece==='r'||move.piece==='q'))return{name:'Back Rank Threat! ğŸ”¥',desc:'Rook/Queen on back rank threatens checkmate!',tag:'tactic'};}
  return null;
}
function detectSacrifice(g,move){
  if(!move.captured)return null;
  if((PV[move.piece]||0)>(PV[move.captured]||0)+100){const pn={p:'Pawn',n:'Knight',b:'Bishop',r:'Rook',q:'Queen'};return{name:`${pn[move.piece]} Sacrifice! ğŸ’«`,desc:`Giving up the ${pn[move.piece]} for greater compensation!`,tag:'tactic'};}
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   TRAINING ANALYSIS â€” ZERO TOLERANCE
//   Flags: inaccuracy â‰¥16cp, mistake â‰¥51cp, blunder â‰¥151cp
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Helper: is a square attacked by the given color?
function isAttackedBy(g, sq, color) {
  const moves = g.moves({verbose:true});
  // Switch perspective: check if any move of 'color' can land on sq
  // chess.js: we can check attacks via a temp game
  const tmpFen = g.fen();
  // Simpler: check all pieces of 'color' and their attack squares
  const board = g.board();
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=board[r][c];
    if(!p||p.color!==color) continue;
    const pSq=String.fromCharCode(97+c)+(8-r);
    const pMoves=g.moves({square:pSq,verbose:true});
    if(pMoves.some(m=>m.to===sq)) return true;
  }
  return false;
}

// Helper: get the lowest-value attacker of a square for a given color
function lowestAttackerValue(g, sq, color) {
  const board = g.board();
  let minVal = Infinity;
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=board[r][c];
    if(!p||p.color!==color) continue;
    const pSq=String.fromCharCode(97+c)+(8-r);
    const pMoves=g.moves({square:pSq,verbose:true});
    if(pMoves.some(m=>m.to===sq)){
      const v=PV[p.type]||0;
      if(v<minVal) minVal=v;
    }
  }
  return minVal===Infinity?null:minVal;
}

// SEE-like check: after player moves to 'to', is the piece hanging (loses material)?
function isHangingAfterMove(g, from, to, promotion) {
  const gCopy = new Chess(g.fen());
  const result = gCopy.move({from, to, promotion:promotion||'q'});
  if(!result) return {hanging:false, loss:0};
  const movedPiece = gCopy.get(to);
  if(!movedPiece) return {hanging:false, loss:0};
  
  const opp = movedPiece.color==='w'?'b':'w';
  const attackerVal = lowestAttackerValue(gCopy, to, opp);
  if(attackerVal===null) return {hanging:false, loss:0};
  
  const pieceVal = PV[movedPiece.type]||0;
  const capturedVal = result.captured ? (PV[result.captured]||0) : 0;
  
  // If attacker value < piece value, we lose material
  // Net loss = piece value - what we captured
  const netLoss = pieceVal - capturedVal;
  
  // Even if attacker > piece value, if there's recapture possible that's fine
  // But simpler heuristic: if any opponent piece can take our moved piece
  // and piece value > captured value, it's a bad trade / hanging
  if(netLoss > 50) {
    return {hanging:true, loss:netLoss};
  }
  return {hanging:false, loss:0};
}

function analyzePlayerMove(from,to,promotion){
  // Depth 3 for fast analysis â€” still catches all tactical blunders including hanging pieces
  const clone=new Chess(game.fen());
  const bestMove=findBestMoveSync(clone,3,0);
  if(!bestMove)return null;

  const evBefore=evaluate(game);

  const gAfterPlayer=new Chess(game.fen());
  const playerResult=gAfterPlayer.move({from,to,promotion:promotion||'q'});
  if(!playerResult)return null;
  const evAfterPlayer=evaluate(gAfterPlayer);

  const gAfterBest=new Chess(game.fen());
  gAfterBest.move({from:bestMove.from,to:bestMove.to,promotion:bestMove.promotion||'q'});
  const evAfterBest=evaluate(gAfterBest);

  // centipawn loss from player's perspective
  // positive diff = player's move is worse than best
  const playerGain=PLAYER==='w'?(evAfterPlayer-evBefore):(evBefore-evAfterPlayer);
  const bestGain  =PLAYER==='w'?(evAfterBest-evBefore) :(evBefore-evAfterBest);
  let diff=bestGain-playerGain;   // how many cp player's move is worse

  const isBestMove=(from===bestMove.from&&to===bestMove.to&&(promotion||'q')===(bestMove.promotion||'q'));

  // TACTICAL OVERRIDE: explicitly check if piece hangs after player's move
  // This catches cases where static eval misses the immediate recapture threat
  if(!isBestMove){
    const hangCheck = isHangingAfterMove(game, from, to, promotion);
    if(hangCheck.hanging && hangCheck.loss > diff){
      diff = hangCheck.loss;
    }
    // Also check: does the move blunder by walking into a capture
    // even if static eval didn't catch it (eval depth limitation)
    const gCheck = new Chess(game.fen());
    gCheck.move({from, to, promotion: promotion||'q'});
    const movedP = gCheck.get(to);
    if(movedP){
      const opp = movedP.color==='w'?'b':'w';
      const attVal = lowestAttackerValue(gCheck, to, opp);
      if(attVal !== null){
        const pieceVal = PV[movedP.type]||0;
        const capGain = playerResult.captured ? (PV[playerResult.captured]||0) : 0;
        const netLoss = pieceVal - capGain;
        // If a lower-value piece can take us, and we lose material
        if(attVal <= pieceVal && netLoss > 50 && netLoss > diff){
          diff = netLoss;
        }
      }
    }
  }

  // Zero-tolerance thresholds (same as 2000-level engine analysis)
  if(isBestMove||diff<=15)return{type:'best',diff,bestMove,playerMove:playerResult,isBestMove:true};
  if(diff<=50)return{type:'inaccuracy',diff,bestMove,playerMove:playerResult,isBestMove:false,evBefore,evAfterPlayer,evAfterBest};
  if(diff<=150)return{type:'mistake',diff,bestMove,playerMove:playerResult,isBestMove:false,evBefore,evAfterPlayer,evAfterBest};
  return{type:'blunder',diff,bestMove,playerMove:playerResult,isBestMove:false,evBefore,evAfterPlayer,evAfterBest};
}

function generateExplanation(analysis,from,to){
  const{type,diff,bestMove,evBefore,evAfterPlayer,evAfterBest}=analysis;
  const pn={p:'Pawn',n:'Knight',b:'Bishop',r:'Rook',q:'Queen',k:'King'};
  const playerPieceName=pn[game.get(from)?.type]||'Piece';
  const bestPieceName=pn[game.get(bestMove.from)?.type]||'Piece';
  let whyWrong='',whyBest='';

  // Is the piece hanging after player's move?
  const gAfterP=new Chess(game.fen());
  gAfterP.move({from,to,promotion:'q'});
  const moved=gAfterP.get(to);
  if(moved){
    const oppMoves=gAfterP.moves({verbose:true});
    const caps=oppMoves.filter(m=>m.to===to);
    if(caps.length){
      const capValue=PV[caps[0].piece]||999;
      if(capValue<=(PV[moved.type]||0)+30){
        whyWrong=`Your ${playerPieceName} on ${to} is immediately capturable by the ${pn[caps[0].piece]} on ${caps[0].from} â€” you lose the piece for free.`;
      }
    }
  }

  // General explanation based on severity
  if(!whyWrong){
    if(type==='blunder')whyWrong=`This is a blunder â€” you lose approximately ${(diff/100).toFixed(1)} pawns of advantage. Your move either hangs material, ignores a major threat, or seriously weakens your position.`;
    else if(type==='mistake')whyWrong=`This move loses about ${(diff/100).toFixed(1)} pawns of advantage compared to the best option. There is a significantly stronger continuation available.`;
    else whyWrong=`Slightly inaccurate (${diff}cp loss). The position is still fine but a sharper option was available.`;
  }

  // Why best move is good
  const gBest=new Chess(game.fen());
  const bm=gBest.move({from:bestMove.from,to:bestMove.to,promotion:bestMove.promotion||'q'});
  if(bm){
    if(bm.captured)whyBest=`${bestPieceName} takes on ${bestMove.to}, winning the ${pn[bm.captured]} â€” that's ${PV[bm.captured]/100} pawn(s) of free material.`;
    else if(gBest.in_check())whyBest=`${bestPieceName} to ${bestMove.to} delivers check, forcing the king to react while maintaining your advantage.`;
    else if(bestMove.flags&&bestMove.flags.includes('k'))whyBest='Kingside castling secures the king and connects the rooks â€” a priority in most openings.';
    else if(bestMove.flags&&bestMove.flags.includes('q'))whyBest='Queenside castling shelters the king and activates the rook.';
    else{
      const det=detectMoveName(game,bestMove);
      if(det&&det.tag==='tactic')whyBest=`This creates a tactical ${det.name.replace(/[!âš¡ğŸ“Œâš”ï¸ğŸ¯ğŸ’«ğŸ‘‘ğŸ°ğŸ´ğŸ´ğŸ”¥]/g,'').trim()} â€” ${det.desc}`;
      else whyBest=`${bestPieceName} to ${bestMove.to} improves piece activity, controls key squares, and consolidates your position${diff>150?' while gaining decisive advantage':''}.`;
    }
  }
  return{whyWrong,whyBest};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   ARROW DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSqCenter(sq){
  const sqSize=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sq-size'));
  const file=sq.charCodeAt(0)-97,rank=parseInt(sq[1])-1;
  const dCol=flipped?7-file:file,dRow=flipped?rank:7-rank;
  return{x:dCol*sqSize+sqSize/2,y:dRow*sqSize+sqSize/2};
}
function drawArrow(fromSq,toSq,color='rgba(34,197,94,0.9)'){
  const canvas=document.getElementById('arrowCanvas');
  const sqSize=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sq-size'));
  canvas.width=sqSize*8;canvas.height=sqSize*8;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!fromSq||!toSq)return;
  const from=getSqCenter(fromSq),to=getSqCenter(toSq);
  const headLen=20,angle=Math.atan2(to.y-from.y,to.x-from.x);
  const toX=to.x-Math.cos(angle)*12,toY=to.y-Math.sin(angle)*12;
  ctx.lineWidth=9;ctx.strokeStyle=color;ctx.fillStyle=color;ctx.lineCap='round';
  ctx.shadowColor=color;ctx.shadowBlur=14;
  ctx.beginPath();ctx.moveTo(from.x,from.y);ctx.lineTo(toX,toY);ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(to.x,to.y);
  ctx.lineTo(to.x-headLen*Math.cos(angle-Math.PI/6),to.y-headLen*Math.sin(angle-Math.PI/6));
  ctx.lineTo(to.x-headLen*Math.cos(angle+Math.PI/6),to.y-headLen*Math.sin(angle+Math.PI/6));
  ctx.closePath();ctx.fill();
}
function clearArrow(){const c=document.getElementById('arrowCanvas');c.getContext('2d').clearRect(0,0,c.width,c.height);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   BOARD RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function displayRCtoSq(dRow,dCol){
  const file=flipped?7-dCol:dCol,rank=flipped?dRow:7-dRow;
  return String.fromCharCode(97+file)+(rank+1);
}
function renderCoords(){
  const rl=document.getElementById('rankLabels'),fl=document.getElementById('fileLabels');
  rl.innerHTML='';fl.innerHTML='';
  for(let r=0;r<8;r++){const sp=document.createElement('span');sp.textContent=flipped?r+1:8-r;rl.appendChild(sp);}
  const files=flipped?['h','g','f','e','d','c','b','a']:['a','b','c','d','e','f','g','h'];
  for(const f of files){const sp=document.createElement('span');sp.textContent=f;fl.appendChild(sp);}
}
function getKingSquare(color){
  const board=game.board();
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=board[r][c];if(p&&p.type==='k'&&p.color===color)return String.fromCharCode(97+c)+(8-r);}
  return null;
}
function renderBoard(){
  const boardEl=document.getElementById('board');
  boardEl.innerHTML='';
  const inCheck=game.in_check(),kSq=inCheck?getKingSquare(game.turn()):null;
  for(let dRow=0;dRow<8;dRow++)for(let dCol=0;dCol<8;dCol++){
    const sq=displayRCtoSq(dRow,dCol);
    const file=sq.charCodeAt(0)-97,rank=parseInt(sq[1])-1;
    const isLight=(file+rank)%2===1;
    const cell=document.createElement('div');
    cell.className='sq '+(isLight?'light':'dark');
    cell.dataset.sq=sq;
    if(sq===selected)cell.classList.add('selected');
    if(sq===lastFrom)cell.classList.add('last-from');
    if(sq===lastTo)cell.classList.add('last-to');
    if(sq===kSq)cell.classList.add('in-check');
    if(pendingTrainingFix&&pendingTrainingFix.bestMove&&sq===pendingTrainingFix.bestMove.to)cell.classList.add('training-best');
    if(pendingTrainingFix&&pendingTrainingFix.playerTo&&sq===pendingTrainingFix.playerTo)cell.classList.add('wrong-sq');
    if(legalDests[sq]){const p=game.get(sq);cell.classList.add(p?'legal-cap':'legal');}
    const piece=game.get(sq);
    if(piece){
      const div=document.createElement('div');
      div.className='piece '+piece.color;
      div.innerHTML=getPieceSVG(piece.color+piece.type);
      cell.appendChild(div);
    }
    const lbl=document.createElement('span');lbl.className='sq-label';
    lbl.style.color=isLight?'#b58863':'#f0d9b5';
    lbl.textContent=(dRow===7?sq[0]:'')+(dCol===0?sq[1]:'');
    cell.appendChild(lbl);
    cell.addEventListener('click',()=>onSqClick(sq));
    boardEl.appendChild(cell);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   INTERACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onSqClick(sq){
  if(game.turn()!==PLAYER||botBusy||pendingPromo||game.game_over())return;
  if(pendingTrainingFix)return;
  const piece=game.get(sq);
  if(selected){
    if(sq===selected){deselect();return;}
    if(piece&&piece.color===PLAYER){selectSq(sq);return;}
    if(legalDests[sq]){attemptMove(selected,sq,legalDests[sq]);return;}
    deselect();return;
  }
  if(piece&&piece.color===PLAYER)selectSq(sq);
}
function selectSq(sq){
  selected=sq;legalDests={};
  const moves=game.moves({verbose:true,square:sq});
  for(const m of moves)legalDests[m.to]=m;
  renderBoard();
}
function deselect(){selected=null;legalDests={};renderBoard();}
function attemptMove(from,to,moveObj){
  const piece=game.get(from);
  const isPromo=piece&&piece.type==='p'&&((piece.color==='w'&&to[1]==='8')||(piece.color==='b'&&to[1]==='1'));
  if(isPromo){pendingPromo={from,to};showPromoModal(PLAYER);return;}
  executePlayerMove(from,to,null);
}

function executePlayerMove(from,to,promotion){
  selected=null;legalDests={};

  if(currentMode==='training'){
    // Show "Analyzingâ€¦" immediately so player sees tap registered (no freeze feel)
    setStatus('Analyzingâ€¦','thinking');
    document.getElementById('thinkBar').classList.add('active');
    // Capture FEN before any state change
    const preFen=game.fen();
    // Defer analysis to next tick so browser repaints first
    setTimeout(()=>{
      const analysis=analyzePlayerMove(from,to,promotion);
      document.getElementById('thinkBar').classList.remove('active');
      if(analysis&&analysis.type!=='best'){
        const explanation=generateExplanation(analysis,from,to);
        pendingTrainingFix={bestMove:analysis.bestMove,playerFrom:from,playerTo:to,playerPromo:promotion,analysis,explanation};
        renderBoard();
        drawArrow(analysis.bestMove.from,analysis.bestMove.to,'rgba(34,197,94,0.92)');
        showTrainingPopup(analysis,explanation,from,to,promotion);
        return;
      }
      if(analysis) addAnalysisEntry('best','â­ Best / Excellent','Engine agrees â€” optimal move!',null);
      commitMove(from,to,promotion,true);
    },0);
    return;
  }

  if(currentMode==='game'){
    // Commit immediately for snappy feel, then analyze retroactively async
    const preFen=game.fen();
    const preMoveFrom=from,preMoveT=to,preMoveProm=promotion;
    commitMove(from,to,promotion,true);
    // Silent referee analysis after commit â€” doesn't block gameplay
    setTimeout(()=>{
      const g=new Chess(preFen);
      const bestMove=findBestMoveSync(g,3,0);
      if(!bestMove)return;
      const evBefore=evaluate(g);
      const gP=new Chess(preFen); gP.move({from:preMoveFrom,to:preMoveT,promotion:preMoveProm||'q'});
      const evP=evaluate(gP);
      const gB=new Chess(preFen); gB.move({from:bestMove.from,to:bestMove.to,promotion:bestMove.promotion||'q'});
      const evB=evaluate(gB);
      const pGain=PLAYER==='w'?(evP-evBefore):(evBefore-evP);
      const bGain=PLAYER==='w'?(evB-evBefore):(evBefore-evB);
      let diff=bGain-pGain;
      const isBest=(preMoveFrom===bestMove.from&&preMoveT===bestMove.to);
      if(!isBest){
        const gHang=new Chess(preFen); const pr=gHang.move({from:preMoveFrom,to:preMoveT,promotion:preMoveProm||'q'});
        const mp=gHang.get(preMoveT);
        if(mp){
          const opp=mp.color==='w'?'b':'w';
          const attVal=lowestAttackerValue(gHang,preMoveT,opp);
          if(attVal!==null){
            const pv=PV[mp.type]||0, cg=pr&&pr.captured?(PV[pr.captured]||0):0;
            const netL=pv-cg;
            if(attVal<=pv&&netL>50&&netL>diff) diff=netL;
          }
        }
      }
      const pn={p:'Pawn',n:'Knight',b:'Bishop',r:'Rook',q:'Queen',k:'King'};
      const pieceName=pn[g.get(preMoveFrom)?.type]||'Piece';
      if(!isBest&&diff>150){
        pendingGameAnnotation={type:'blunder',bestMove,moveNotation:`${pieceName} ${preMoveFrom}â†’${preMoveT}`,diff};
        // Retroactively attach to last player move row
        attachGameAnnotation();
      } else if(!isBest&&diff>50){
        pendingGameAnnotation={type:'mistake',bestMove,moveNotation:`${pieceName} ${preMoveFrom}â†’${preMoveT}`,diff};
        attachGameAnnotation();
      }
    },0);
    return;
  }

  commitMove(from,to,promotion,true);
}

function attachGameAnnotation(){
  if(!pendingGameAnnotation||!moveHistory.length)return;
  const row=moveHistory[moveHistory.length-1];
  // Attach to the color that just moved (PLAYER's color)
  if(PLAYER==='w'){
    if(row.white&&row.white!=='â€¦') row.wRef=pendingGameAnnotation;
  } else {
    row.bRef=pendingGameAnnotation;
  }
  pendingGameAnnotation=null;
  renderMoveLog();
}

function commitMove(from,to,promotion,isPlayerMove=false){
  clearArrow();
  const gBefore=new Chess(game.fen());
  const result=game.move({from,to,promotion:promotion||undefined});
  if(!result){console.error('Illegal:',from,to);renderBoard();return;}
  lastFrom=from;lastTo=to;
  const moveName=detectMoveName(gBefore,result);
  logMove(result,moveName,isPlayerMove);
  showMoveNameBanner(moveName);
  updateCaptured();updateEvalBar();renderBoard();updateStatus();updateActiveLabels();
  if(game.game_over()){showGameOver();return;}
  scheduleBotMove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   TRAINING POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTrainingPopup(analysis,explanation,from,to,promotion){
  const labels={blunder:'ğŸš¨ Blunder!',mistake:'âš ï¸ Mistake',inaccuracy:'ğŸ’¡ Inaccuracy'};
  const subs={blunder:`Serious error â€” ${(analysis.diff/100).toFixed(1)} pawns lost.`,mistake:`Meaningful error â€” ${(analysis.diff/100).toFixed(1)} pawns lost.`,inaccuracy:`Slight inaccuracy â€” ${analysis.diff}cp below best.`};
  const icons={blunder:'ğŸš¨',mistake:'âš ï¸',inaccuracy:'ğŸ’¡'};
  const pn={p:'Pawn',n:'Knight',b:'Bishop',r:'Rook',q:'Queen',k:'King'};
  const piece=game.get(from);
  document.getElementById('popupIcon').textContent=icons[analysis.type];
  document.getElementById('popupTitle').textContent=labels[analysis.type];
  document.getElementById('popupSubtitle').textContent=subs[analysis.type];
  document.getElementById('popupYourMoveHL').textContent=`${pn[piece?.type]||'?'} ${from} â†’ ${to}${promotion?' â†’ '+pn[promotion]:''}`;
  document.getElementById('popupYourMove').textContent=explanation.whyWrong;
  const bestPiece=game.get(pendingTrainingFix.bestMove.from);
  document.getElementById('popupBestMove').textContent=`${pn[bestPiece?.type]||'?'} ${pendingTrainingFix.bestMove.from} â†’ ${pendingTrainingFix.bestMove.to}`+(pendingTrainingFix.bestMove.promotion?` â†’ ${pn[pendingTrainingFix.bestMove.promotion]}`:'');
  document.getElementById('popupWhyBest').textContent=explanation.whyBest;
  document.getElementById('trainingPopup').classList.add('show');
}
function applyBestMove(){
  document.getElementById('trainingPopup').classList.remove('show');
  if(!pendingTrainingFix)return;
  const{bestMove}=pendingTrainingFix;
  addAnalysisEntry('best','ğŸ¤– Best Move Applied',"Engine's top choice played on your behalf.",`${bestMove.from}â†’${bestMove.to}`);
  pendingTrainingFix=null;
  commitMove(bestMove.from,bestMove.to,bestMove.promotion||undefined);
}
function dismissTraining(){
  document.getElementById('trainingPopup').classList.remove('show');
  if(!pendingTrainingFix)return;
  const{playerFrom,playerTo,playerPromo,analysis}=pendingTrainingFix;
  addAnalysisEntry(analysis.type,
    analysis.type==='blunder'?'ğŸš¨ Blunder':analysis.type==='mistake'?'âš ï¸ Mistake':'ğŸ’¡ Inaccuracy',
    'Played anyway â€” study this position!',null);
  pendingTrainingFix=null;
  commitMove(playerFrom,playerTo,playerPromo||undefined);
}
function addAnalysisEntry(type,title,text,move){
  const log=document.getElementById('analysisLog');
  const entry=document.createElement('div');
  entry.className='analysis-entry '+type;
  entry.innerHTML=`<div class="analysis-badge ${type}">${title}</div><div class="analysis-text">${text}</div>`+(move?`<div class="analysis-best"><strong>Move:</strong> ${move}</div>`:'');
  log.insertBefore(entry,log.firstChild);
  while(log.children.length>6)log.removeChild(log.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   MOVE NAME BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showMoveNameBanner(info){
  const banner=document.getElementById('moveNameBanner');
  if(!info){banner.classList.remove('show');return;}
  const tagColors={tactic:'#fca5a5',opening:'#93c5fd',special:'#d8b4fe',strat:'#5eead4'};
  banner.style.borderColor=tagColors[info.tag]||'var(--gold)';
  banner.style.background=`rgba(${info.tag==='tactic'?'239,68,68':info.tag==='opening'?'59,130,246':info.tag==='special'?'168,85,247':'20,184,166'},0.08)`;
  document.getElementById('moveNameTitle').textContent=info.name;
  document.getElementById('moveNameDesc').textContent=info.desc;
  banner.classList.add('show');
  // Stays until next move â€” no auto-hide
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   EVAL BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateEvalBar(){
  const ev=evaluate(game);
  const pct=Math.max(5,Math.min(95,50+ev/25));
  document.getElementById('evalBarWhite').style.width=pct+'%';
  if(document.getElementById('tEvalBarWhite'))document.getElementById('tEvalBarWhite').style.width=pct+'%';
  let label='Equal âš–ï¸',textW='',textB='';
  if(ev>800){label='White is winning! ğŸ†';textW=`+${(ev/100).toFixed(1)}`;}
  else if(ev>300){label=`White better (+${(ev/100).toFixed(1)})`;textW=`+${(ev/100).toFixed(1)}`;}
  else if(ev>60){label='Slight white edge';textW=`+${(ev/100).toFixed(1)}`;}
  else if(ev<-800){label='Black is winning! ğŸ’€';textB=`+${(-ev/100).toFixed(1)}`;}
  else if(ev<-300){label=`Black better (+${(-ev/100).toFixed(1)})`;textB=`+${(-ev/100).toFixed(1)}`;}
  else if(ev<-60){label='Slight black edge';textB=`+${(-ev/100).toFixed(1)}`;}
  document.getElementById('evalLabel').textContent=label;
  if(document.getElementById('tEvalLabel'))document.getElementById('tEvalLabel').textContent=label;
  document.getElementById('evalTextW').textContent=textW;
  document.getElementById('evalTextB').textContent=textB;
  // Flip label orientation if player is black
  if(PLAYER==='b'){
    document.getElementById('gaugeLabelWhite').textContent='White (Bot) â—»';
    document.getElementById('gaugeLabelBlack').textContent='â—¼ Black (You)';
  } else {
    document.getElementById('gaugeLabelWhite').textContent='You (White) â—»';
    document.getElementById('gaugeLabelBlack').textContent='â—¼ Bot (Black)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   BOT â€” async so UI never freezes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scheduleBotMove(){
  if(game.turn()!==BOT||game.game_over())return;
  botBusy=true;
  setStatus('Bot is thinkingâ€¦','thinking');
  document.getElementById('thinkBar').classList.add('active');
  updateActiveLabels();
  const conf=STAGES[currentStage];
  const fenStr=game.fen();
  findBestMoveAsync(fenStr,conf.depth,conf.noise,(best)=>{
    if(!botBusy)return; // was cancelled (e.g. new game)
    runBotMove(best);
  });
}
function runBotMove(best){
  document.getElementById('thinkBar').classList.remove('active');
  if(game.game_over()||game.turn()!==BOT){botBusy=false;return;}
  if(!best){botBusy=false;return;}
  const gBefore=new Chess(game.fen());
  const result=game.move({from:best.from,to:best.to,promotion:best.promotion||undefined});
  if(!result){const moves=game.moves({verbose:true});if(moves.length)game.move(moves[0]);}
  lastFrom=best.from;lastTo=best.to;
  const moveName=detectMoveName(gBefore,result||best);
  logMove(result||best,moveName,false);
  showMoveNameBanner(moveName);
  updateCaptured();updateEvalBar();
  botBusy=false;
  renderBoard();updateStatus();updateActiveLabels();
  if(game.game_over()){showGameOver();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   PROMOTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPromoModal(color){
  const modal=document.getElementById('promoModal'),cont=document.getElementById('promoPieces');
  cont.innerHTML='';
  for(const type of['q','r','b','n']){
    const div=document.createElement('div');
    div.className='promo-piece';
    div.innerHTML=getPieceSVG(color+type);
    div.onclick=()=>{modal.classList.remove('show');const{from,to}=pendingPromo;pendingPromo=null;executePlayerMove(from,to,type);};
    cont.appendChild(div);
  }
  modal.classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   UNDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function undoMove(){
  if(botBusy||pendingPromo||pendingTrainingFix)return;
  game.undo();game.undo();
  if(moveHistory.length){const last=moveHistory[moveHistory.length-1];if(last.black)last.black=null;else moveHistory.pop();}
  selected=null;legalDests={};lastFrom=null;lastTo=null;pendingTrainingFix=null;
  clearArrow();
  document.getElementById('trainingPopup').classList.remove('show');
  renderMoveLog();updateCaptured();updateEvalBar();renderBoard();updateStatus();updateActiveLabels();
  showMoveNameBanner(null);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   MOVE LOG â€” with referee blunder detection in game mode
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function logMove(move,moveName,isPlayerMove){
  if(!move)return;
  const tagHtml=moveName?`<span class="log-tag tag-${moveName.tag}">${moveName.name.split('!')[0].split('(')[0].trim()}</span>`:'';
  const san=move.san||(move.from+move.to);
  const entry={san,tagHtml,color:move.color,num:0,referee:null};

  if(move.color==='w'){
    moveHistory.push({num:moveHistory.length+1,white:san,whiteTag:tagHtml,black:null,blackTag:'',wRef:null,bRef:null});
  } else {
    if(moveHistory.length&&moveHistory[moveHistory.length-1].black===null){
      moveHistory[moveHistory.length-1].black=san;
      moveHistory[moveHistory.length-1].blackTag=tagHtml;
    } else {
      moveHistory.push({num:moveHistory.length+1,white:'â€¦',whiteTag:'',black:san,blackTag:tagHtml,wRef:null,bRef:null});
    }
  }

  // In game mode, silently analyze the player's move for blunders/mistakes
  // and attach a referee note (no interruption â€” just logs it after)
  if(currentMode==='game' && isPlayerMove){
    // We already committed the move, so we need to analyze retroactively
    // We'll tag with analysis result stored during executePlayerMove
    if(pendingGameAnnotation){
      const row=moveHistory[moveHistory.length-1];
      if(move.color==='w'){
        row.wRef=pendingGameAnnotation;
      } else {
        row.bRef=pendingGameAnnotation;
      }
      pendingGameAnnotation=null;
    }
  }
  renderMoveLog();
}

function renderMoveLog(){
  const log=document.getElementById('moveLog');log.innerHTML='';
  moveHistory.forEach((row,i)=>{
    const div=document.createElement('div');div.className='log-row';
    div.innerHTML=`<span class="log-num">${i+1}.</span><span class="log-w">${row.white||''} ${row.whiteTag||''}</span><span class="log-b">${row.black||''} ${row.blackTag||''}</span>`;
    log.appendChild(div);
    // Referee annotation for white blunder
    if(row.wRef){
      log.appendChild(buildRefRow(row.wRef,'You'));
    }
    // Referee annotation for black
    if(row.bRef){
      const isBot=(PLAYER==='w');
      log.appendChild(buildRefRow(row.bRef,isBot?'Bot':'You'));
    }
  });
  log.scrollTop=log.scrollHeight;
}

function buildRefRow(ref,who){
  const div=document.createElement('div');
  const typeClass=ref.type==='blunder'?'blunder':ref.type==='mistake'?'mistake':'best';
  const icon=ref.type==='blunder'?'ğŸš¨':ref.type==='mistake'?'âš ï¸':'â­';
  const label=ref.type==='blunder'?'Blunder':ref.type==='mistake'?'Mistake':'Best Move';
  div.className=`log-referee ${typeClass}`;
  let bestHtml='';
  if(ref.bestMove&&ref.type!=='best'){
    bestHtml=`<div class="ref-best">â–¶ Best: ${ref.bestMove.from}â†’${ref.bestMove.to}${ref.bestMove.promotion?'='+ref.bestMove.promotion.toUpperCase():''}</div>`;
  }
  div.innerHTML=`<div class="ref-icon">${icon}</div><div class="ref-body"><div><span class="ref-who">${who}</span><span class="ref-label ${typeClass}">${label}</span> <span class="ref-move">${ref.moveNotation||''}</span></div>${bestHtml}</div>`;
  return div;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   CAPTURED PIECES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STARTING={p:8,n:2,b:2,r:2,q:1};
function updateCaptured(){
  const board=game.board();
  const on={w:{p:0,n:0,b:0,r:0,q:0},b:{p:0,n:0,b:0,r:0,q:0}};
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){const p=board[r][c];if(p&&p.type!=='k')on[p.color][p.type]++;}
  let capByPlayer='',capByBot='';
  for(const t of['q','r','b','n','p']){
    const bCap=STARTING[t]-on.b[t],wCap=STARTING[t]-on.w[t];
    for(let i=0;i<bCap;i++)capByPlayer+=PIECES_UNICODE['b'+t];
    for(let i=0;i<wCap;i++)capByBot+=PIECES_UNICODE['w'+t];
  }
  // Top bar = opponent, bottom bar = player
  if(PLAYER==='w'){
    document.getElementById('capturedByTop').textContent=capByPlayer;
    document.getElementById('capturedByBottom').textContent=capByBot;
  } else {
    document.getElementById('capturedByTop').textContent=capByBot;
    document.getElementById('capturedByBottom').textContent=capByPlayer;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(text,cls=''){
  const el=document.getElementById('statusText');
  el.textContent=text;
  el.style.color=cls==='thinking'?'var(--gold)':cls==='win'?'var(--green)':cls==='lose'?'var(--red)':'var(--white)';
}
function updateStatus(){
  if(game.in_checkmate()){const won=game.turn()===BOT;setStatus(won?'â™› Checkmate â€” You Win!':'â˜  Checkmate â€” Bot Wins',won?'win':'lose');}
  else if(game.in_stalemate())setStatus('âŠ˜ Stalemate â€” Draw');
  else if(game.in_draw())setStatus('âŠ˜ Draw');
  else if(game.in_check())setStatus(game.turn()===PLAYER?'âš  You are in Check!':'âš¡ Bot is in Check!',game.turn()===PLAYER?'lose':'win');
  else setStatus(game.turn()===PLAYER?`Your turn (${PLAYER==='w'?'White':'Black'}) â™Ÿ`:`Bot's turn (${BOT==='w'?'White':'Black'}) ğŸ¤–`,game.turn()===PLAYER?'':'thinking');
}
function updateActiveLabels(){
  const isPlayer=game.turn()===PLAYER&&!botBusy;
  // Bottom bar is always the player
  document.getElementById('barBottom').classList.toggle('active-turn',isPlayer);
  document.getElementById('barTop').classList.toggle('active-turn',!isPlayer);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   PLAYER BAR LABELS (update based on chosen color)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePlayerBarLabels(){
  if(PLAYER==='w'){
    document.getElementById('topAvatar').textContent='ğŸ¤–';
    document.getElementById('topName').textContent='Bot';
    document.getElementById('topRating').textContent='500';
    document.getElementById('topClock').textContent='â€”';
    document.getElementById('bottomAvatar').textContent='ğŸ‘‘';
    document.getElementById('bottomName').textContent='You (White)';
    document.getElementById('bottomRating').textContent='2000+';
    document.getElementById('colorBadge').textContent='â¬œ White';
    document.getElementById('colorBadge').style.color='#fde68a';
    document.getElementById('colorBadge').style.borderColor='rgba(253,230,138,0.4)';
  } else {
    document.getElementById('topAvatar').textContent='ğŸ‘‘';
    document.getElementById('topName').textContent='You (Black)';
    document.getElementById('topRating').textContent='2000+';
    document.getElementById('topClock').textContent='â€”';
    document.getElementById('bottomAvatar').textContent='ğŸ¤–';
    document.getElementById('bottomName').textContent='Bot';
    document.getElementById('bottomRating').textContent='500';
    document.getElementById('colorBadge').textContent='â¬› Black';
    document.getElementById('colorBadge').style.color='#94a3b8';
    document.getElementById('colorBadge').style.borderColor='rgba(148,163,184,0.4)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   GAME OVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showGameOver(){
  const overlay=document.getElementById('gameOverlay');
  const title=document.getElementById('overlayTitle'),msg=document.getElementById('overlayMsg');
  if(game.in_checkmate()){
    if(game.turn()===PLAYER){title.textContent='â˜  You Lost';msg.textContent='The bot outplayed you. Study, train, come back stronger!';}
    else{title.textContent='â™› You Won!';msg.textContent=`Checkmate on Stage ${currentStage+1}!`;
      if(currentMode==='game'){setTimeout(()=>{overlay.classList.remove('show');showStageUp();},1200);return;}
    }
  } else if(game.in_stalemate()){title.textContent='âŠ˜ Stalemate';msg.textContent='No legal moves â€” drawn.';}
  else{title.textContent='âŠ˜ Draw';msg.textContent=game.in_threefold_repetition()?'Threefold repetition.':game.insufficient_material()?'Insufficient material.':'50-move rule.';}
  overlay.classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   STAGE PROGRESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showStageUp(){
  stagesComplete[currentStage]=true;
  localStorage.setItem('pkc_stages',JSON.stringify(stagesComplete));
  const next=currentStage<9?currentStage+1:null;
  document.getElementById('stageUpTitle').textContent=next!==null?`Stage ${currentStage+1} Cleared!`:'ğŸ† All 10 Stages Complete!';
  document.getElementById('stageUpNext').textContent=next!==null?`Advancing to Stage ${next+1}`:'You are a Chess Master!';
  document.getElementById('stageUpMsg').textContent=next!==null?STAGES[next].desc:'You have conquered all 10 stages. Elite achieved!';
  spawnConfetti();
  document.getElementById('stageUp').classList.add('show');
}
function advanceStage(){
  document.getElementById('stageUp').classList.remove('show');
  if(currentStage<9)currentStage++;
  renderStageUI();newGame();
}
function spawnConfetti(){
  const con=document.getElementById('confettiContainer');con.innerHTML='';
  const colors=['#f5c842','#3b82f6','#a855f7','#22c55e','#ef4444','#f97316'];
  for(let i=0;i<80;i++){const p=document.createElement('div');p.className='confetti-piece';p.style.cssText=`left:${Math.random()*100}%;background:${colors[Math.floor(Math.random()*colors.length)]};width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;animation-duration:${2+Math.random()*3}s;animation-delay:${Math.random()*1.5}s;`;con.appendChild(p);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   SPLASH / HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSplashStages(){
  const el=document.getElementById('splashStages');el.innerHTML='';
  for(let i=0;i<10;i++){const pip=document.createElement('div');pip.className='stage-pip'+(stagesComplete[i]?' completed':(i===currentStage?' current':''));pip.textContent=i+1;el.appendChild(pip);}
}
function startMode(mode){
  currentMode=mode;
  PLAYER=playerColor;BOT=playerColor==='w'?'b':'w';
  // Flip board if player chose black
  flipped=(playerColor==='b');
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('app').classList.add('show');
  const badge=document.getElementById('modeBadge');
  badge.textContent=mode==='training'?'Training':'Game';
  badge.className='topbar-mode-badge '+mode;
  document.getElementById('trainingPanel').style.display=mode==='training'?'flex':'none';
  updatePlayerBarLabels();
  newGame();renderStageUI();
}
function goHome(){
  document.getElementById('splash').classList.remove('hidden');
  document.getElementById('app').classList.remove('show');
  document.getElementById('gameOverlay').classList.remove('show');
  renderSplashStages();
}
function renderStageUI(){
  document.getElementById('stageLabel').textContent=currentStage+1;
  const grid=document.getElementById('stageGrid');grid.innerHTML='';
  for(let i=0;i<10;i++){const btn=document.createElement('div');btn.className='stage-btn'+(stagesComplete[i]?' done':(i===currentStage?' current':''));btn.textContent=stagesComplete[i]?'âœ“':(i+1);btn.title=`Stage ${i+1}: ${STAGES[i].desc}`;grid.appendChild(btn);}
  document.getElementById('stageDesc').textContent=`Stage ${currentStage+1}: ${STAGES[currentStage].desc}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   NEW GAME / FLIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newGame(){
  game=new Chess();selected=null;legalDests={};lastFrom=null;lastTo=null;botBusy=false;pendingPromo=null;moveHistory=[];pendingTrainingFix=null;pendingGameAnnotation=null;
  document.getElementById('gameOverlay').classList.remove('show');
  document.getElementById('promoModal').classList.remove('show');
  document.getElementById('trainingPopup').classList.remove('show');
  document.getElementById('thinkBar').classList.remove('active');
  document.getElementById('analysisLog').innerHTML='';
  clearArrow();showMoveNameBanner(null);
  renderCoords();renderBoard();renderMoveLog();updateCaptured();updateStatus();updateActiveLabels();updateEvalBar();renderStageUI();
  // If player chose black, bot makes first move
  if(PLAYER==='b')scheduleBotMove();
}
function flipBoard(){flipped=!flipped;renderCoords();renderBoard();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderSplashStages();
selectColor('w'); // default white
// Inject SVG kings into splash color picker
document.getElementById('previewWhite').innerHTML=SVG_PIECES['wk'];
document.getElementById('previewBlack').innerHTML=SVG_PIECES['bk'];
</script>
</body>
</html>
